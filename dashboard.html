<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>FichIt - Tableau de bord</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="Votre espace personnel FichIt avec vos fiches gÃ©nÃ©rÃ©es" name="description" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;600;700&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />

    <style>
      :root { --accent:#ff385c; --accent-hover:#e33251; }

      body {
        font-family:'Plus Jakarta Sans', sans-serif;
        background:linear-gradient(135deg,#fff8f9 0%,#ffe3ea 100%);
        min-height:100vh;
        display:flex;
        flex-direction:column;
      }

      .navbar { background:#fff; height:64px; display:flex; align-items:center; }
      .navbar-brand img { height:40px; display:block; }

      .btn-primary {
        background-color:var(--accent)!important;
        border-color:var(--accent)!important;
        color:#fff!important;
      }
      .btn-primary:hover { background-color:var(--accent-hover)!important; }

      .dashboard-container {
        max-width:1100px;
        margin:6rem auto 3rem;
        background:#fff;
        border-radius:16px;
        padding:2.5rem;
        box-shadow:0 8px 30px rgba(0,0,0,.08);
        width:100%;
      }

      .dashboard-header {
        display:flex;
        flex-wrap:wrap;
        justify-content:space-between;
        align-items:center;
        margin-bottom:2rem;
      }

      .dashboard-header h2 {
        color:var(--accent);
        font-weight:700;
        margin-bottom:1rem;
      }

      .new-fiche-btn {
        display:flex; align-items:center; gap:8px;
        background-color:var(--accent); border:none; color:#fff;
        border-radius:999px; padding:.6rem 1.4rem;
        font-weight:600; font-size:1rem;
      }
      .new-fiche-btn:hover { background-color:var(--accent-hover); }

      .search-bar { position:relative; width:100%; max-width:350px; }
      .search-bar input {
        width:100%; border-radius:50px; padding:.6rem 1rem .6rem 2.5rem;
        border:1px solid #ddd; outline:none;
      }
      .search-bar i {
        position:absolute; top:50%; left:10px; transform:translateY(-50%); color:#aaa;
      }

      .fiche-card {
        border:1px solid #eee; border-radius:12px;
        padding:1.5rem; background:#fff;
        box-shadow:0 3px 10px rgba(0,0,0,.05);
        transition: transform .2s ease;
      }
      .fiche-card:hover { transform: translateY(-3px); }

      .fiche-title { color:#333; font-weight:600; margin-bottom:.5rem; }
      .fiche-date { color:#888; font-size:.9rem; }

      .logout-btn {
        border:1px solid var(--accent); color:var(--accent);
        background:transparent; font-weight:500;
        border-radius:999px; padding:.45rem 1.2rem;
      }
      .logout-btn:hover { background-color:var(--accent); color:#fff; }

      #userName {
        color:#444; font-weight:600;
        max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      }

      /* PLAN BADGE â€” Identique Ã  index */
      .plan-badge{
        display:inline-flex; align-items:center; gap:6px;
        border:1px solid var(--accent); color:var(--accent); background:#fff;
        padding:4px 10px; border-radius:999px; font-size:.85rem; font-weight:700;
        line-height:1;
      }
      .plan-badge.premium{
        background:var(--accent); color:#fff; border-color:var(--accent);
      }
      .plan-dot{
        width:8px; height:8px; border-radius:50%;
        background:var(--accent); display:inline-block;
      }
      .plan-badge.premium .plan-dot{ background:#fff; }

      .upgrade-btn {
        border:1px dashed var(--accent);
        color:var(--accent);
        background:transparent;
        font-weight:600; border-radius:999px;
        padding:.35rem .9rem; font-size:.9rem;
      }
      .upgrade-btn:hover { background:var(--accent); color:#fff; }

      .site-footer { margin-top:auto; padding:1.25rem 0; text-align:center; color:#777; }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg fixed-top navbar-light px-4">
      <a href="index.html" class="navbar-brand p-0"><img src="img/logo.png" alt="FichIt Logo"></a>

      <div class="ms-auto me-3 d-flex align-items-center gap-3 flex-wrap">
        <span id="userName" class="d-none d-sm-inline"></span>

        <!-- BADGE ALIGNÃ‰ AVEC INDEX -->
        <span id="planBadge" class="plan-badge">
          <span class="plan-dot"></span>
          <span id="planBadgeText">Gratuit</span>
        </span>

        <a id="upgradeBtn" class="upgrade-btn d-none" href="https://buy.stripe.com/bJedRb2Y65wS0RDgbA1Nu00">Mettre Ã  niveau</a>
        <button id="logoutBtn" class="logout-btn">Se dÃ©connecter</button>
      </div>
    </nav>

    <div class="dashboard-container">
      <div class="dashboard-header">
        <h2>Tableau de bord</h2>
        <div class="d-flex align-items-center gap-3 flex-wrap">
          <button class="new-fiche-btn" id="newFicheBtn"><i class="fas fa-plus"></i> Nouvelle fiche</button>
          <div class="search-bar"><i class="fas fa-search"></i><input type="text" id="searchInput" placeholder="Rechercher une fiche" /></div>
        </div>
      </div>

      <div id="ficheList" class="row g-3 text-center">
        <p class="text-muted">Chargement des fiches...</p>
      </div>
    </div>

    <footer class="site-footer">Â© 2025 FichIt â€“ Tous droits rÃ©servÃ©s.</footer>

    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import { getAuth, onAuthStateChanged, onIdTokenChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
      import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

      const firebaseConfig = { apiKey:"AIzaSyCUYgbDvFb4FjaMrsL-2-wVjlME5iODVOs", authDomain:"fichit-64628.firebaseapp.com", projectId:"fichit-64628" };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const ficheList = document.getElementById("ficheList");
      const logoutBtn = document.getElementById("logoutBtn");
      const searchInput = document.getElementById("searchInput");
      const userNameEl = document.getElementById("userName");
      const planBadge = document.getElementById("planBadge");
      const planBadgeText = document.getElementById("planBadgeText");
      const upgradeBtn = document.getElementById("upgradeBtn");

      let fiches = [];

      function afficherFiches(data){
        ficheList.innerHTML = "";
        if(!data.length){ ficheList.innerHTML = "<p class='text-muted'>Aucune fiche trouvÃ©e.</p>"; return; }
        data.forEach((fiche)=>{
          const card = document.createElement("div");
          card.className = "col-md-6 col-lg-4";
          card.innerHTML = `
          <div class="fiche-card text-start">
            <h5 class="fiche-title">${fiche.titre||"Sans titre"}</h5>
            <p class="fiche-date">${fiche.date||""}</p>
          </div>`;
          ficheList.appendChild(card);
        });
      }

      searchInput.addEventListener("input", (e)=>{
        const q=e.target.value.toLowerCase();
        const filtres=fiches.filter(f=> (f.titre||"").toLowerCase().includes(q));
        afficherFiches(filtres);
      });

      async function chargerFiches(uid){
        try{
          const qy=query(collection(db,"fiches"), where("userId","==",uid));
          const qs=await getDocs(qy);
          fiches=qs.docs.map(d=>d.data());
          afficherFiches(fiches);
        }catch{
          ficheList.innerHTML = "<p class='text-danger'>Erreur de chargement des fiches.</p>";
        }
      }

      // ðŸ”¥ Badge identique Ã  celui de lâ€™index
      function majBadgeDepuisClaims(tokenResult){
        const isPremium = !!tokenResult.claims.premium;
        if(isPremium){
          planBadge.classList.add('premium');
          planBadgeText.textContent='Premium';
          upgradeBtn.classList.add('d-none');
        } else {
          planBadge.classList.remove('premium');
          planBadgeText.textContent='Gratuit';
          upgradeBtn.classList.remove('d-none');
        }
      }

      async function rafraichirEtMajBadge(user, forceRefresh=false){
        const tokenResult = await user.getIdTokenResult(forceRefresh);
        majBadgeDepuisClaims(tokenResult);
      }

      onAuthStateChanged(auth, async (user)=>{
        if(!user){ window.location.href='login.html'; return; }

        userNameEl.textContent = user.displayName || user.email || 'Utilisateur';
        userNameEl.classList.remove('d-none');

        await rafraichirEtMajBadge(user, false);
        try{ await rafraichirEtMajBadge(user, true); }catch{}

        onIdTokenChanged(auth, async (u)=>{ if(u){ try{ await rafraichirEtMajBadge(u,false);}catch{} } });

        await chargerFiches(user.uid);
      });

      document.getElementById('newFicheBtn').addEventListener('click', ()=> window.location.href='upload.html');

      logoutBtn.addEventListener('click', ()=>{
        logoutBtn.textContent='DÃ©connexion...';
        logoutBtn.disabled=true;
        signOut(auth).then(()=>window.location.href='login.html');
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
