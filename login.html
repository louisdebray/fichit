<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>FichIt - Connexion / Inscription</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="Connexion et inscription à FichIt pour générer vos fiches de révision" name="description" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />
    <style>
      :root { --accent:#ff385c; --accent-hover:#e33251; }
      body { background:linear-gradient(135deg,#fff8f9 0%,#ffe3ea 100%); font-family:'Plus Jakarta Sans',sans-serif; min-height:100vh; display:flex; flex-direction:column; }
      .navbar { background:#fff; height:64px; display:flex; align-items:center; }
      .login-section { flex:1; display:flex; align-items:center; justify-content:center; padding:3rem 1rem; }
      .form-container { max-width:460px; width:100%; background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:2.5rem; }
      .form-title { color:var(--accent); font-weight:700; text-align:center; margin-bottom:1.5rem; }
      .nav-pills .nav-link { border-radius:999px; color:var(--accent); border:1px solid var(--accent); margin:0 .3rem; }
      .nav-pills .nav-link.active { background:var(--accent); color:#fff; }
      .btn-primary { background-color:var(--accent)!important; border-color:var(--accent)!important; }
      .btn-primary:hover { background-color:var(--accent-hover)!important; }
      .footer { background:#fff; padding:1.25rem 0; text-align:center; color:#777; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg fixed-top navbar-light px-4">
      <a href="index.html" class="navbar-brand p-0"><img src="img/logo.png" alt="FichIt Logo" style="height:40px" /></a>
    </nav>

    <div class="login-section">
      <div class="form-container">
        <h2 class="form-title">Connexion / Inscription</h2>

        <ul class="nav nav-pills justify-content-center mb-4" id="tabs">
          <li class="nav-item me-2"><a class="nav-link active" data-bs-toggle="pill" href="#login">Connexion</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#register">Inscription</a></li>
        </ul>

        <div class="tab-content">
          <div id="login" class="tab-pane fade show active">
            <form id="loginForm">
              <div class="mb-3"><input type="email" id="loginEmail" class="form-control" placeholder="Adresse e-mail" required /></div>
              <div class="mb-3"><input type="password" id="loginPassword" class="form-control" placeholder="Mot de passe" required /></div>
              <button type="submit" class="btn btn-primary w-100">Se connecter</button>
              <div id="loginSuccess" class="alert alert-success mt-2" style="display:none"></div>
            </form>
          </div>

          <div id="register" class="tab-pane fade">
            <form id="registerForm">
              <div class="mb-3"><input type="text" id="registerName" class="form-control" placeholder="Nom complet" required /></div>
              <div class="mb-3"><input type="email" id="registerEmail" class="form-control" placeholder="Adresse e-mail" required /></div>
              <div class="mb-3"><input type="password" id="registerPassword" class="form-control" placeholder="Mot de passe" required /></div>
              <button type="submit" class="btn btn-primary w-100">S'inscrire</button>
              <div id="registerSuccess" class="alert alert-success mt-2" style="display:none"></div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer">© 2025 FichIt – Tous droits réservés.</footer>

    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCUYgbDvFb4FjaMrsL-2-wVjlME5iODVOs",
        authDomain: "fichit-64628.firebaseapp.com",
        projectId: "fichit-64628"
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      const urlParams = new URLSearchParams(window.location.search);
      const plan = urlParams.get('plan');
      const tabParam = urlParams.get('tab');

      function activateTab(targetId) {
        const loginPane = document.getElementById('login');
        const registerPane = document.getElementById('register');
        const loginLink = document.querySelector('#tabs .nav-link[href="#login"]');
        const registerLink = document.querySelector('#tabs .nav-link[href="#register"]');
        [loginLink, registerLink].forEach(l => l.classList.remove('active'));
        [loginPane, registerPane].forEach(p => p.classList.remove('show','active'));
        if (targetId === 'register') { registerLink.classList.add('active'); registerPane.classList.add('show','active'); }
        else { loginLink.classList.add('active'); loginPane.classList.add('show','active'); }
      }

      function handleFormSubmission(formId, successMessage) {
        const form = document.getElementById(formId);
        const successDiv = document.getElementById(formId === 'registerForm' ? 'registerSuccess' : 'loginSuccess');
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const btn = form.querySelector('button[type="submit"]');
          const old = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ...';
          try {
            if (formId === 'registerForm') {
              const name = document.getElementById('registerName').value;
              const email = document.getElementById('registerEmail').value;
              const password = document.getElementById('registerPassword').value;
              const cred = await createUserWithEmailAndPassword(auth, email, password);
              await updateProfile(cred.user, { displayName: name });
              if (successDiv) { successDiv.textContent = successMessage; successDiv.style.display = 'block'; setTimeout(()=>successDiv.style.display='none',1200); }

              if (plan === 'premium') {
                const STRIPE_BASE = 'https://buy.stripe.com/bJedRb2Y65wS0RDgbA1Nu00';
                const uid = cred.user.uid;
                const mail = encodeURIComponent(cred.user.email || '');
                const payUrl = `${STRIPE_BASE}?client_reference_id=${encodeURIComponent(uid)}&prefilled_email=${mail}`;
                window.location.href = payUrl;
              } else {
                window.location.href = 'dashboard.html';
              }
            } else {
              const email = document.getElementById('loginEmail').value;
              const password = document.getElementById('loginPassword').value;
              await signInWithEmailAndPassword(auth, email, password);
              if (successDiv) { successDiv.textContent = 'Connexion réussie !'; successDiv.style.display = 'block'; setTimeout(()=>successDiv.style.display='none',800); }
              window.location.href = 'dashboard.html';
            }
          } catch (err) {
            let errorMsg = "Une erreur est survenue";

            if (formId === 'loginForm') {
              errorMsg = "Adresse mail ou mot de passe invalide";
            } else {
              if (err.code === "auth/email-already-in-use") {
                errorMsg = "Ce compte existe déjà";
              } else {
                errorMsg = "Erreur lors de l'inscription";
              }
            }

            alert(errorMsg);
          } finally {
            btn.disabled = false; btn.innerHTML = old;
          }
        });
      }

      handleFormSubmission('registerForm', 'Inscription réussie ! Bienvenue sur FichIt.');
      handleFormSubmission('loginForm', 'Connexion réussie ! Bienvenue sur FichIt.');

      document.addEventListener('DOMContentLoaded', () => {
        if (tabParam === 'login') activateTab('login');
        else if (tabParam === 'register' || plan) activateTab('register');
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
