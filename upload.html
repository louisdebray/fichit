<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>FichIt - Déposer un fichier</title>
    <link rel="icon" type="image/png" href="img/logof.png" />
    <link rel="apple-touch-icon" href="img/logof.png" />
<meta name="theme-color" content="#ff385c">


    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="Uploader vos PDF pour générer des fiches de révision" name="description" />

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />

    <style>
      :root { --accent:#ff385c; --accent-hover:#e33251; }
      html, body { margin:0; }
      body { font-family:'Plus Jakarta Sans', sans-serif; background: linear-gradient(135deg, #fff8f9 0%, #ffe3ea 100%); }
      .navbar { background:#fff; height:64px; display:flex; align-items:center; }
      .navbar-brand img { height:40px; display:block; }

      .plan-badge{ display:inline-flex; align-items:center; gap:6px; border:1px solid var(--accent); color:var(--accent); background:#fff; padding:4px 10px; border-radius:999px; font-size:.85rem; font-weight:700; line-height:1; }
      .plan-badge.premium{ background:var(--accent); color:#fff; border-color:var(--accent); }
      .plan-dot{ width:8px; height:8px; border-radius:50%; background:var(--accent); display:inline-block; }
      .plan-badge.premium .plan-dot{ background:#fff; }

      .upload-section { min-height: calc(100vh - 120px); display:flex; align-items:center; justify-content:center; }
      .upload-box { background:#fff; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.08); padding:3rem; max-width:520px; width:100%; text-align:center; }
      .upload-box h2 { color:var(--accent); font-weight:700; margin-bottom:1.2rem; }
      .actions { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
      .btn-pill { border:none; border-radius:999px; padding:.75rem 1.4rem; font-size:1.05rem; font-weight:600; cursor:pointer; transition:all .2s ease; }
      .btn-choose { background-color:#f1f3f5; color:#333; }
      .btn-choose:hover { background-color:#e9ecef; }
      .btn-generate { background-color:var(--accent); color:#fff; }
      .btn-generate:hover { background-color:var(--accent-hover); }
      .btn-generate:disabled { opacity:.6; cursor:not-allowed; }
      .file-input { display:none; }
      .file-meta { margin-top:.75rem; color:#555; font-size:.95rem; }
      .change-file { font-size:.9rem; margin-top:.25rem; }
      .change-file button { background:none; border:none; color:var(--accent); text-decoration:underline; cursor:pointer; padding:0; }
      .footer { background:#fff; border-top:1px solid #eee; }
      #spinner { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#fff; opacity:0; visibility:hidden; transition:opacity .2s ease; z-index:9999; }
      #spinner.show { opacity:1; visibility:visible; }
      #planBadgeText.placeholder { opacity:.5; }

      /* Drawer mobile */
      .avatar{width:34px;height:34px;border-radius:50%;background:#ffe3ea;color:#a41230;font-weight:700;display:flex;align-items:center;justify-content:center;}
      .drawer-badge { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:.85rem; font-weight:700; line-height:1; border:1px solid var(--accent); color:var(--accent); }
      .drawer-badge.premium{ background:var(--accent); color:#fff; }
      .drawer-dot{ width:8px;height:8px;border-radius:50%; background:currentColor; }
      .mobile-drawer-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.28); display:none; z-index:1051; }
      .mobile-drawer{ position:fixed; top:0; right:-320px; width:280px; height:100vh; background:#fff; box-shadow:-10px 0 30px rgba(0,0,0,.12); z-index:1052; padding:18px; transition:right .2s ease; display:flex; flex-direction:column; gap:12px; }
      .mobile-drawer.open{ right:0; }
      .mobile-drawer-backdrop.show{ display:block; }

      /* Mobile-only (préserve desktop) */
      @media (max-width: 992px) {
        body { padding-top:56px; }
        .navbar { height:56px; padding-left:12px; padding-right:12px; position:relative; }
        .navbar-brand img { height:32px; }
        #mobileMenuBtn { position:absolute; right:12px; top:50%; transform:translateY(-50%); border:0; background:transparent; font-size:1.25rem; }
        #userName, #planBadge, #upgradeBtn, #navButtons { display:none !important; }

        .upload-section { min-height: calc(100vh - 56px - 64px); padding: 16px 12px; }
        .upload-box { max-width:100%; width:100%; padding:1.25rem; border-radius:14px; box-shadow:0 8px 28px rgba(0,0,0,.07); }
        .upload-box h2 { font-size:1.25rem; margin-bottom:.6rem; }
        .upload-box p { font-size:.95rem; margin-bottom:1rem !important; }
        .actions { flex-direction:column; gap:8px; align-items:stretch; }
        .btn-pill { width:100%; padding:.7rem 1rem; font-size:1rem; }
        .file-meta { font-size:.9rem; word-break: break-word; }
        #spinner .spinner-border { width:2.25rem!important; height:2.25rem!important; }
        .footer { padding-top:12px !important; padding-bottom:12px !important; }
      }
      @media (max-width: 360px) {
        .navbar { padding-left:8px; padding-right:8px; }
        .upload-box { padding:1rem; }
        .btn-pill { padding:.65rem .9rem; font-size:.95rem; }
      }
    </style>
  </head>

  <body>
    <div id="spinner"><div class="spinner-border text-primary" style="width:3rem;height:3rem"></div></div>

    <nav class="navbar navbar-expand-lg fixed-top navbar-light px-4">
      <a href="index.html" class="navbar-brand p-0"><img src="img/logo.png" alt="FichIt Logo"></a>

      <!-- Burger (mobile) -->
      <button class="navbar-toggler d-lg-none" id="mobileMenuBtn" aria-label="Menu">
        <span class="fa fa-bars"></span>
      </button>

      <div class="ms-auto d-flex align-items-center gap-3 flex-wrap">
        <span id="userName" class="text-dark fw-semibold d-none d-md-inline"></span>
        <span id="planBadge" class="plan-badge"><span class="plan-dot"></span><span id="planBadgeText" class="placeholder">…</span></span>
        <a id="upgradeBtn" class="btn btn-outline-primary rounded-pill py-2 px-3 d-none" href="https://buy.stripe.com/bJedRb2Y65wS0RDgbA1Nu00" rel="noopener">Mettre à niveau</a>
        <div id="navButtons"></div>
      </div>
    </nav>

    <!-- Drawer mobile -->
    <div class="mobile-drawer-backdrop" id="drawerBackdrop"></div>
    <div class="mobile-drawer" id="drawer" aria-hidden="true">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="d-flex align-items-center gap-2">
          <div id="drawerAvatar" class="avatar">U</div>
          <div class="d-flex flex-column">
            <div id="drawerName" class="fw-semibold">Utilisateur</div>
            <div><span id="drawerBadge" class="drawer-badge"><span class="drawer-dot"></span><span id="drawerBadgeText">Gratuit</span></span></div>
          </div>
        </div>
        <button class="btn btn-sm btn-light" id="closeDrawer" aria-label="Fermer"><i class="fas fa-times"></i></button>
      </div>
      <hr class="mt-0">
      <div id="drawerActions" class="d-grid gap-2"></div>
    </div>

    <div class="container upload-section">
      <div class="upload-box">
        <h2>Déposez votre fichier</h2>
        <p class="mb-3 text-muted">Générez votre fiche de révision en quelques secondes.</p>

        <input type="file" id="fileInput" class="file-input" accept="application/pdf" />
        <div class="actions mb-2">
          <button class="btn-pill btn-choose" id="uploadBtn"><i class="fas fa-file-upload me-2"></i> Choisir un fichier</button>
          <button class="btn-pill btn-generate" id="generateBtn" disabled><i class="fas fa-magic me-2"></i> Générer la fiche</button>
        </div>

        <div class="file-meta" id="fileInfo">Format pris en charge : PDF</div>
        <div class="change-file d-none" id="changeFile"><button type="button" id="changeFileBtn">Changer de fichier</button></div>

        <div id="uploadStatus" class="mt-2 text-success fw-semibold small"></div>
      </div>
    </div>

    <div class="container-fluid footer py-4 mt-5">
      <div class="container text-center">
        <small class="text-muted">© 2025 FichIt – Tous droits réservés.</small>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script unique -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import { getAuth, onAuthStateChanged, onIdTokenChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

      const firebaseConfig = { apiKey:"AIzaSyCUYgbDvFb4FjaMrsL-2-wVjlME5iODVOs", authDomain:"fichit-64628.firebaseapp.com", projectId:"fichit-64628", storageBucket:"fichit-64628.appspot.com" };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      setPersistence(auth, browserLocalPersistence).catch(()=>{});

      const onLoginPage = /\/login\.html$/i.test(location.pathname);

      // UI refs
      const spinner = document.getElementById('spinner');
      const navButtons = document.getElementById('navButtons');
      const userNameEl = document.getElementById('userName');
      const planBadge = document.getElementById('planBadge');
      const planBadgeText = document.getElementById('planBadgeText');
      const upgradeBtn = document.getElementById('upgradeBtn');

      // Upload refs
      const uploadBtn = document.getElementById('uploadBtn');
      const generateBtn = document.getElementById('generateBtn');
      const fileInput = document.getElementById('fileInput');
      const fileInfo = document.getElementById('fileInfo');
      const changeFile = document.getElementById('changeFile');
      const changeFileBtn = document.getElementById('changeFileBtn');
      const uploadStatus = document.getElementById('uploadStatus');

      // Drawer refs
      const drawer = document.getElementById('drawer');
      const drawerBackdrop = document.getElementById('drawerBackdrop');
      const drawerActions = document.getElementById('drawerActions');
      const drawerAvatar = document.getElementById('drawerAvatar');
      const drawerName = document.getElementById('drawerName');
      const drawerBadge = document.getElementById('drawerBadge');
      const drawerBadgeText = document.getElementById('drawerBadgeText');
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const closeDrawer = document.getElementById('closeDrawer');

      const openDrawer = () => { drawer.classList.add('open'); drawerBackdrop.classList.add('show'); drawer.setAttribute('aria-hidden','false'); };
      const closeDrawerFn = () => { drawer.classList.remove('open'); drawerBackdrop.classList.remove('show'); drawer.setAttribute('aria-hidden','true'); };
      mobileMenuBtn?.addEventListener('click', openDrawer);
      closeDrawer?.addEventListener('click', closeDrawerFn);
      drawerBackdrop?.addEventListener('click', closeDrawerFn);

      let selectedFile = null;

      function setPlanUI(isPremium) {
        planBadge.classList.toggle('premium', !!isPremium);
        planBadgeText.textContent = isPremium ? 'Premium' : 'Gratuit';
        planBadgeText.classList.remove('placeholder');
        upgradeBtn.classList.toggle('d-none', !!isPremium);

        drawerBadge.classList.toggle('premium', !!isPremium);
        drawerBadgeText.textContent = isPremium ? 'Premium' : 'Gratuit';
      }

      async function resolvePlanFast(user) {
        try { const t1 = await user.getIdTokenResult(false); if (t1?.claims) { setPlanUI(!!t1.claims.premium); return; } } catch {}
        try { const t2 = await user.getIdTokenResult(true);  if (t2?.claims) { setPlanUI(!!t2.claims.premium); return; } } catch {}
        setPlanUI(false);
      }

      function setDrawerLoggedOut(){
        drawerAvatar.textContent='U';
        drawerName.textContent='Invité';
        drawerBadge.classList.remove('premium');
        drawerBadgeText.textContent='Gratuit';
        drawerActions.innerHTML = `
          <a class="btn btn-primary w-100" href="login.html?tab=register"><i class="fas fa-user-plus me-1"></i> Créer un compte</a>
          <a class="btn btn-light w-100" href="login.html?tab=login"><i class="fas fa-sign-in-alt me-1"></i> Se connecter</a>
        `;
      }

      function setDrawerLoggedIn(user){
        const name = user.displayName || user.email || 'Utilisateur';
        const initial = (name?.trim()?.[0] || 'U').toUpperCase();
        drawerAvatar.textContent = initial;
        drawerName.textContent = name;
        drawerActions.innerHTML = `
          <a class="btn btn-primary w-100" href="dashboard.html"><i class="fas fa-chart-line me-1"></i> Mon tableau de bord</a>
          <button id="drawerLogout" class="btn btn-outline-danger w-100"><i class="fas fa-sign-out-alt me-1"></i> Se déconnecter</button>
        `;
        document.getElementById('drawerLogout')?.addEventListener('click', () => {
          const b = document.getElementById('drawerLogout'); b.disabled=true; b.textContent='Déconnexion…';
          signOut(auth).finally(()=>location.href='login.html?tab=login');
        });
      }

      // === Redirection safe : attendre la restauration de session ===
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userNameEl.textContent = user.displayName || user.email || "Utilisateur";
          userNameEl.classList.remove('d-none');
          setDrawerLoggedIn(user);
          await resolvePlanFast(user);
          onIdTokenChanged(auth, (u) => { if (u) resolvePlanFast(u); });

          // Zone nav desktop
          navButtons.innerHTML = `
            <a href="dashboard.html" class="btn btn-primary rounded-pill py-2 px-4 me-2">Mon tableau de bord</a>
            <button id="logoutBtn" class="btn btn-outline-danger rounded-pill py-2 px-3">Se déconnecter</button>
          `;
          document.getElementById("logoutBtn")?.addEventListener("click", () => {
            const btn = document.getElementById("logoutBtn");
            btn.disabled = true; btn.textContent = "Déconnexion...";
            signOut(auth).finally(() => { location.href = "login.html?tab=login"; });
          });
          return;
        }

        // Pas connecté : ne redirige PAS tout de suite; attend un court délai et recheck
        setDrawerLoggedOut();
        setTimeout(() => {
          if (!auth.currentUser && !onLoginPage) {
            const redirect = encodeURIComponent(location.pathname + location.search);
            location.href = `login.html?tab=login&redirect=${redirect}`;
          }
        }, 800);
      });

      // Upload interactions
      uploadBtn.addEventListener('click', () => fileInput.click());
      changeFileBtn?.addEventListener('click', () => fileInput.click());

      fileInput.addEventListener('change', () => {
        const file = fileInput.files?.[0] || null;
        uploadStatus.textContent = "";
        uploadStatus.classList.remove("text-danger");
        uploadStatus.classList.add("text-success");

        if (!file) {
          selectedFile = null;
          fileInfo.textContent = "Format pris en charge : PDF";
          changeFile.classList.add('d-none');
          generateBtn.disabled = true;
          return;
        }
        if (file.type !== "application/pdf") {
          selectedFile = null;
          fileInfo.textContent = "Format pris en charge : PDF";
          changeFile.classList.add('d-none');
          generateBtn.disabled = true;
          uploadStatus.textContent = "Veuillez sélectionner un fichier PDF.";
          uploadStatus.classList.replace("text-success", "text-danger");
          return;
        }

        selectedFile = file;
        fileInfo.textContent = `Fichier sélectionné : ${file.name} (${Math.round(file.size/1024)} Ko)`;
        changeFile.classList.remove('d-none');
        generateBtn.disabled = false;
      });

      function lockUI(locked) {
        generateBtn.disabled = locked || !selectedFile;
        uploadBtn.disabled = locked;
        spinner.classList.toggle("show", !!locked);
      }

      document.getElementById("generateBtn").addEventListener("click", async () => {
        if (!selectedFile) return;
        const user = auth.currentUser;
        if (!user) return;

        lockUI(true);
        uploadStatus.textContent = "Envoi du PDF…";

        const ficheId = (crypto?.randomUUID && crypto.randomUUID()) || (Date.now() + "_" + Math.random().toString(16).slice(2));

        try {
          const fd = new FormData();
          fd.append("file", selectedFile, selectedFile.name);
          fd.append("userId", user.uid);
          fd.append("ficheId", ficheId);
          fd.append("filename", selectedFile.name);

          await fetch("https://fichit-api.vercel.app/api/generate-fiche", { method: "POST", body: fd }).catch(() => {});
          uploadStatus.textContent = "Redirection vers le tableau de bord…";
          try { localStorage.setItem("lastFicheId", ficheId); } catch {}
          setTimeout(() => {
            lockUI(false);
            window.location.href = `dashboard.html?ficheId=${encodeURIComponent(ficheId)}`;
          }, 200);

        } catch (err) {
          console.error(err);
          uploadStatus.textContent = "Échec d’upload.";
          uploadStatus.classList.replace("text-success", "text-danger");
          lockUI(false);
        }
      });
    </script>
  </body>
</html>
