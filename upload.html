<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>FichIt - Déposer un fichier</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="Uploader vos PDF pour générer des fiches de révision" name="description" />

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;600;700&family=Rubik:wght@400;500&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />

    <style>
      :root { --accent:#ff385c; --accent-hover:#e33251; }
      body {
        font-family:'Plus Jakarta Sans', sans-serif;
        background: linear-gradient(135deg, #fff8f9 0%, #ffe3ea 100%);
      }

      /* Navbar compacte sans trait */
      .navbar { background:#fff; height:64px; display:flex; align-items:center; box-shadow:none; border:none !important; }
      .navbar-brand img { height:40px; display:block; margin-top:0; }
      .navbar .btn { padding:.45rem 1.2rem !important; font-size:.95rem; }

      /* === Plan badge — identique à index.html === */
      .plan-badge{
        display:inline-flex; align-items:center; gap:6px;
        border:1px solid var(--accent); color:var(--accent); background:#fff;
        padding:4px 10px; border-radius:999px; font-size:.85rem; font-weight:700;
        line-height:1;
      }
      .plan-badge.premium{ background:var(--accent); color:#fff; border-color:var(--accent); }
      .plan-dot{ width:8px; height:8px; border-radius:50%; background:var(--accent); display:inline-block; }
      .plan-badge.premium .plan-dot{ background:#fff; }

      /* Section d’upload */
      .upload-section { min-height: calc(100vh - 120px); display:flex; align-items:center; justify-content:center; }
      .upload-box {
        background:#fff; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.08);
        padding:3rem; max-width:480px; width:100%; text-align:center;
      }
      .upload-box h2 { color:var(--accent); font-weight:700; margin-bottom:1.5rem; }

      .upload-btn {
        background-color:var(--accent); color:#fff; border:none; border-radius:999px;
        padding:.75rem 2rem; font-size:1.1rem; font-weight:600; cursor:pointer; transition:background-color .2s ease;
      }
      .upload-btn:hover { background-color:var(--accent-hover); }

      .file-input { display:none; }
      .upload-info { margin-top:1rem; color:#666; font-size:.9rem; }

      .footer { background:#fff; border-top:1px solid #eee; }

      /* Spinner */
      #spinner {
        position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
        background:#fff; opacity:0; visibility:hidden; transition:opacity .3s ease; z-index:9999;
      }
      #spinner.show { opacity:1; visibility:visible; }
    </style>
  </head>

  <body>
    <!-- Spinner -->
    <div id="spinner">
      <div class="spinner-border text-primary" style="width:3rem;height:3rem" role="status"></div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top navbar-light px-4">
      <a href="index.html" class="navbar-brand p-0">
        <img src="img/logo.png" alt="FichIt Logo">
      </a>

      <div class="ms-auto d-flex align-items-center gap-3 flex-wrap">
        <span id="userName" class="text-dark fw-semibold d-none d-md-inline"></span>

        <!-- Badge plan (identique à l’index) -->
        <span id="planBadge" class="plan-badge">
          <span class="plan-dot"></span>
          <span id="planBadgeText">Gratuit</span>
        </span>

        <a id="upgradeBtn" class="btn btn-outline-primary rounded-pill py-2 px-3 d-none" href="https://buy.stripe.com/bJedRb2Y65wS0RDgbA1Nu00">Mettre à niveau</a>
        <div id="navButtons"></div>
      </div>
    </nav>

    <!-- Upload Section -->
    <div class="container upload-section">
      <div class="upload-box wow fadeInUp" data-wow-delay="0.3s">
        <h2>Déposez votre fichier</h2>
        <p class="mb-4 text-muted">Générez votre fiche de révision en quelques secondes.</p>

        <input type="file" id="fileInput" class="file-input" accept="application/pdf" />
        <button class="upload-btn" id="uploadBtn"><i class="fas fa-file-upload me-2"></i> Choisir un fichier</button>

        <p class="upload-info">Format pris en charge : PDF</p>
        <div id="uploadStatus" class="mt-4 text-success fw-semibold"></div>
      </div>
    </div>

    <!-- Footer -->
    <div class="container-fluid footer py-4 mt-5">
      <div class="container text-center">
        <small class="text-muted">© 2025 FichIt – Tous droits réservés.</small>
      </div>
    </div>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase + Auth + Badge plan -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

      const firebaseConfig = { apiKey:"AIzaSyCUYgbDvFb4FjaMrsL-2-wVjlME5iODVOs", authDomain:"fichit-64628.firebaseapp.com", projectId:"fichit-64628" };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      const spinner = document.getElementById('spinner');
      spinner.classList.add('show');
      setTimeout(() => spinner.classList.remove('show'), 700);

      const navButtons = document.getElementById('navButtons');
      const userNameEl = document.getElementById('userName');
      const planBadge = document.getElementById('planBadge');
      const planBadgeText = document.getElementById('planBadgeText');
      const upgradeBtn = document.getElementById('upgradeBtn');

      function setPlanBadgeUI({ isPremium }) {
        if (isPremium) {
          planBadge.classList.add('premium');
          planBadgeText.textContent = 'Premium';
          upgradeBtn.classList.add('d-none');
        } else {
          planBadge.classList.remove('premium');
          planBadgeText.textContent = 'Gratuit';
          upgradeBtn.classList.remove('d-none');
        }
      }

      async function updateBadgeFromClaims(user, force=false){
        try{
          const tokenResult = await user.getIdTokenResult(force);
          const isPremium = !!(tokenResult && tokenResult.claims && tokenResult.claims.premium);
          setPlanBadgeUI({ isPremium });
          return isPremium;
        }catch{
          // en cas d’erreur, on n’affiche pas Premium
          setPlanBadgeUI({ isPremium:false });
          return false;
        }
      }

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "login.html?tab=login";
          return;
        }

        const name = user.displayName || user.email || "Utilisateur";
        userNameEl.textContent = name;
        userNameEl.classList.remove('d-none');

        // Boutons nav (dashboard + logout)
        navButtons.innerHTML = `
          <a href="dashboard.html" class="btn btn-primary rounded-pill py-2 px-4 me-2">Mon tableau de bord</a>
          <button id="logoutBtn" class="btn btn-outline-danger rounded-pill py-2 px-3">Se déconnecter</button>
        `;
        const logoutBtn = document.getElementById("logoutBtn");
        logoutBtn.addEventListener("click", () => {
          logoutBtn.disabled = true;
          logoutBtn.textContent = "Déconnexion...";
          signOut(auth).finally(() => window.location.href = "login.html?tab=login");
        });

        // 1) Utilise le token courant
        let hasPremium = await updateBadgeFromClaims(user, false);
        // 2) Force un refresh (utile si retour de Stripe)
        if (!hasPremium) { hasPremium = await updateBadgeFromClaims(user, true); }
        // 3) Retente quelques fois pendant ~30s (propagation des claims)
        if (!hasPremium){
          let tries = 0;
          const iv = setInterval(async ()=>{
            tries++;
            const ok = await updateBadgeFromClaims(user, true);
            if (ok || tries >= 10) clearInterval(iv); // 10 * 3s = 30s
          }, 3000);
        }
      });

      // Upload
      const uploadBtn = document.getElementById('uploadBtn');
      const fileInput = document.getElementById('fileInput');
      const uploadStatus = document.getElementById('uploadStatus');

      uploadBtn.addEventListener('click', () => fileInput.click());

      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (!file) return;
        if (file.type !== "application/pdf") {
          uploadStatus.textContent = "Veuillez sélectionner un fichier PDF.";
          uploadStatus.classList.replace("text-success", "text-danger");
          return;
        }
        uploadStatus.classList.replace("text-danger", "text-success");
        uploadStatus.textContent = "Fichier sélectionné : " + file.name;
      });
    </script>
  </body>
</html>