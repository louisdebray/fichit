<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>FichIt - Déposer un fichier</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="Uploader vos PDF pour générer des fiches de révision" name="description" />

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />

    <style>
      :root { --accent:#ff385c; --accent-hover:#e33251; }
      body { font-family:'Plus Jakarta Sans', sans-serif; background: linear-gradient(135deg, #fff8f9 0%, #ffe3ea 100%); }
      .navbar { background:#fff; height:64px; display:flex; align-items:center; }
      .navbar-brand img { height:40px; display:block; }
      .plan-badge{
        display:inline-flex; align-items:center; gap:6px;
        border:1px solid var(--accent); color:var(--accent); background:#fff;
        padding:4px 10px; border-radius:999px; font-size:.85rem; font-weight:700; line-height:1;
      }
      .plan-badge.premium{ background:var(--accent); color:#fff; border-color:var(--accent); }
      .plan-dot{ width:8px; height:8px; border-radius:50%; background:var(--accent); display:inline-block; }
      .plan-badge.premium .plan-dot{ background:#fff; }

      .upload-section { min-height: calc(100vh - 120px); display:flex; align-items:center; justify-content:center; }
      .upload-box {
        background:#fff; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.08);
        padding:3rem; max-width:520px; width:100%; text-align:center;
      }
      .upload-box h2 { color:var(--accent); font-weight:700; margin-bottom:1.2rem; }
      .actions { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
      .btn-pill { border:none; border-radius:999px; padding:.75rem 1.4rem; font-size:1.05rem; font-weight:600; cursor:pointer; transition:all .2s ease; }
      .btn-choose { background-color:#f1f3f5; color:#333; }
      .btn-choose:hover { background-color:#e9ecef; }
      .btn-generate { background-color:var(--accent); color:#fff; }
      .btn-generate:hover { background-color:var(--accent-hover); }
      .btn-generate:disabled { opacity:.6; cursor:not-allowed; }
      .file-input { display:none; }
      .file-meta { margin-top:.75rem; color:#555; font-size:.95rem; }
      .change-file { font-size:.9rem; margin-top:.25rem; }
      .change-file button {
        background:none; border:none; color:var(--accent);
        text-decoration:underline; cursor:pointer; padding:0;
      }
      .footer { background:#fff; border-top:1px solid #eee; }
      #spinner {
        position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
        background:#fff; opacity:0; visibility:hidden; transition:opacity .2s ease; z-index:9999;
      }
      #spinner.show { opacity:1; visibility:visible; }
      #planBadgeText.placeholder { opacity:.5; }
      /* === Mobile-only fixes (préserve totalement le desktop) === */
@media (max-width: 576px) {
  /* Espace sous la navbar fixed pour éviter que le contenu passe dessous */
  body { padding-top: 56px; }

  /* Navbar compacte et lisible */
  .navbar { height: 56px; padding-left: 12px; padding-right: 12px; }
  .navbar-brand img { height: 32px; }

  /* Alléger la zone de droite de la navbar */
  #userName { display: none !important; }               /* masquer le nom pour aérer */
  #planBadge { transform: scale(.92); }
  #planBadgeText.placeholder::after { content: "…"; }   /* garde un feedback léger */
  #upgradeBtn { padding: .35rem .7rem; font-size: .85rem; }

  /* Empêcher les éléments de la nav de déborder */
  .navbar .ms-auto { gap: .5rem !important; }

  /* Section upload centrée et respirante */
  .upload-section {
    min-height: calc(100vh - 56px - 64px); /* viewport - navbar - footer approx */
    padding: 16px 12px;
  }

  /* Carte d’upload fluide sur mobile */
  .upload-box {
    max-width: 100%;
    width: 100%;
    padding: 1.25rem;
    border-radius: 14px;
    box-shadow: 0 8px 28px rgba(0,0,0,.07);
  }

  .upload-box h2 {
    font-size: 1.25rem;
    margin-bottom: .6rem;
  }

  .upload-box p {
    font-size: .95rem;
    margin-bottom: 1rem !important;
  }

  /* Boutons: pile verticale, largeur 100% */
  .actions {
    flex-direction: column;
    gap: 8px;
    align-items: stretch;
  }

  .btn-pill {
    width: 100%;
    padding: .7rem 1rem;
    font-size: 1rem;
    border-radius: 999px;
  }

  /* Infos fichier + "changer de fichier" mieux placés */
  .file-meta {
    font-size: .9rem;
    word-break: break-word;
  }

  .change-file {
    margin-top: .25rem;
  }

  .change-file button {
    font-size: .9rem;
  }

  /* Spinner: overlay léger et taille adaptée */
  #spinner .spinner-border {
    width: 2.25rem !important;
    height: 2.25rem !important;
  }

  /* Footer compact */
  .footer { padding-top: 12px !important; padding-bottom: 12px !important; }
  .footer small { font-size: .85rem; }
}

/* Petits mobiles très étroits (iPhone SE & co) */
@media (max-width: 360px) {
  .navbar { padding-left: 8px; padding-right: 8px; }
  #planBadge { display: none !important; }  /* on garde seulement le bouton dashboard/logout si présent */
  .upload-box { padding: 1rem; }
  .btn-pill { padding: .65rem .9rem; font-size: .95rem; }
}
    </style>
  </head>

  <body>
    <div id="spinner">
      <div class="spinner-border text-primary" style="width:3rem;height:3rem"></div>
    </div>

    <nav class="navbar navbar-expand-lg fixed-top navbar-light px-4">
      <a href="index.html" class="navbar-brand p-0">
        <img src="img/logo.png" alt="FichIt Logo">
      </a>
      <div class="ms-auto d-flex align-items-center gap-3 flex-wrap">
        <span id="userName" class="text-dark fw-semibold d-none d-md-inline"></span>

        <span id="planBadge" class="plan-badge">
          <span class="plan-dot"></span>
          <span id="planBadgeText" class="placeholder">…</span>
        </span>

        <a id="upgradeBtn" class="btn btn-outline-primary rounded-pill py-2 px-3 d-none"
           href="https://buy.stripe.com/bJedRb2Y65wS0RDgbA1Nu00" rel="noopener">Mettre à niveau</a>

        <div id="navButtons"></div>
      </div>
    </nav>

    <div class="container upload-section">
      <div class="upload-box">
        <h2>Déposez votre fichier</h2>
        <p class="mb-3 text-muted">Générez votre fiche de révision en quelques secondes.</p>

        <input type="file" id="fileInput" class="file-input" accept="application/pdf" />
        <div class="actions mb-2">
          <button class="btn-pill btn-choose" id="uploadBtn"><i class="fas fa-file-upload me-2"></i> Choisir un fichier</button>
          <button class="btn-pill btn-generate" id="generateBtn" disabled><i class="fas fa-magic me-2"></i> Générer la fiche</button>
        </div>

        <div class="file-meta" id="fileInfo">Format pris en charge : PDF</div>
        <div class="change-file d-none" id="changeFile"><button type="button" id="changeFileBtn">Changer de fichier</button></div>

        <div id="uploadStatus" class="mt-2 text-success fw-semibold small"></div>
      </div>
    </div>

    <div class="container-fluid footer py-4 mt-5">
      <div class="container text-center">
        <small class="text-muted">© 2025 FichIt – Tous droits réservés.</small>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import { getAuth, onAuthStateChanged, onIdTokenChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

      // ✅ Auth uniquement (aucun Firestore côté client)
      const firebaseConfig = {
        apiKey:"AIzaSyCUYgbDvFb4FjaMrsL-2-wVjlME5iODVOs",
        authDomain:"fichit-64628.firebaseapp.com",
        projectId:"fichit-64628",
        storageBucket:"fichit-64628.appspot.com"
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      const spinner = document.getElementById('spinner');
      const navButtons = document.getElementById('navButtons');
      const userNameEl = document.getElementById('userName');
      const planBadge = document.getElementById('planBadge');
      const planBadgeText = document.getElementById('planBadgeText');
      const upgradeBtn = document.getElementById('upgradeBtn');

      const uploadBtn = document.getElementById('uploadBtn');
      const generateBtn = document.getElementById('generateBtn');
      const fileInput = document.getElementById('fileInput');
      const fileInfo = document.getElementById('fileInfo');
      const changeFile = document.getElementById('changeFile');
      const changeFileBtn = document.getElementById('changeFileBtn');
      const uploadStatus = document.getElementById('uploadStatus');

      let selectedFile = null;

      function setPlanBadgeUI(isPremium) {
        planBadge.classList.toggle('premium', !!isPremium);
        planBadgeText.textContent = isPremium ? 'Premium' : 'Gratuit';
        planBadgeText.classList.remove('placeholder');
        upgradeBtn.classList.toggle('d-none', !!isPremium);
      }
      async function resolvePlanFast(user) {
        try { const t1 = await user.getIdTokenResult(false); if (t1?.claims) { setPlanBadgeUI(!!t1.claims.premium); return; } } catch {}
        try { const t2 = await user.getIdTokenResult(true);  if (t2?.claims) { setPlanBadgeUI(!!t2.claims.premium); return; } } catch {}
        setPlanBadgeUI(false);
      }

      onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "login.html?tab=login"; return; }
        userNameEl.textContent = user.displayName || user.email || "Utilisateur";
        userNameEl.classList.remove('d-none');
        resolvePlanFast(user);
        onIdTokenChanged(auth, u => { if (u) resolvePlanFast(u); });

        navButtons.innerHTML = `
          <a href="dashboard.html" class="btn btn-primary rounded-pill py-2 px-4 me-2">Mon tableau de bord</a>
          <button id="logoutBtn" class="btn btn-outline-danger rounded-pill py-2 px-3">Se déconnecter</button>
        `;
        const logoutBtn = document.getElementById("logoutBtn");
        logoutBtn.addEventListener("click", () => {
          logoutBtn.disabled = true;
          logoutBtn.textContent = "Déconnexion...";
          signOut(auth).finally(() => window.location.href = "login.html?tab=login");
        });
      });

      uploadBtn.addEventListener('click', () => fileInput.click());
      changeFileBtn?.addEventListener('click', () => fileInput.click());

      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        uploadStatus.textContent = "";
        uploadStatus.classList.remove("text-danger");
        uploadStatus.classList.add("text-success");

        if (!file) {
          selectedFile = null;
          fileInfo.textContent = "Format pris en charge : PDF";
          changeFile.classList.add('d-none');
          generateBtn.disabled = true;
          return;
        }
        if (file.type !== "application/pdf") {
          selectedFile = null;
          fileInfo.textContent = "Format pris en charge : PDF";
          changeFile.classList.add('d-none');
          generateBtn.disabled = true;
          uploadStatus.textContent = "Veuillez sélectionner un fichier PDF.";
          uploadStatus.classList.replace("text-success", "text-danger");
          return;
        }

        selectedFile = file;
        fileInfo.textContent = `Fichier sélectionné : ${file.name} (${Math.round(file.size/1024)} Ko)`;
        changeFile.classList.remove('d-none');
        generateBtn.disabled = false;
      });

      function lockUI(locked) {
        generateBtn.disabled = locked || !selectedFile;
        uploadBtn.disabled = locked;
        if (locked) spinner.classList.add("show"); else spinner.classList.remove("show");
      }

      // ✅ Upload direct au backend (multipart) —> backend met en "processing" puis génère en asynchrone
      document.getElementById("generateBtn").addEventListener("click", async () => {
        if (!selectedFile) return;
        const user = auth.currentUser;
        if (!user) return;

        lockUI(true);
        uploadStatus.textContent = "Envoi du PDF…";

        const ficheId = (crypto?.randomUUID && crypto.randomUUID())
          || (Date.now() + "_" + Math.random().toString(16).slice(2));

        try {
          const fd = new FormData();
          fd.append("file", selectedFile, selectedFile.name);
          fd.append("userId", user.uid);
          fd.append("ficheId", ficheId);
          fd.append("filename", selectedFile.name);

          // IMPORTANT: ne pas attendre la génération, l’API répond 202 rapidement
          await fetch("https://fichit-api.vercel.app/api/generate-fiche", {
            method: "POST",
            body: fd,
            // pas de Content-Type manuelle (FormData gère le boundary)
          }).catch(() => { /* on ignore pour l'UX */ });

          uploadStatus.textContent = "Redirection vers le tableau de bord…";
          try { localStorage.setItem("lastFicheId", ficheId); } catch {}
          setTimeout(() => {
            lockUI(false);
            window.location.href = `dashboard.html?ficheId=${encodeURIComponent(ficheId)}`;
          }, 200);

        } catch (err) {
          console.error(err);
          uploadStatus.textContent = "Échec d’upload.";
          uploadStatus.classList.replace("text-success", "text-danger");
          lockUI(false);
        }
      });
    </script>
  </body>
</html>

