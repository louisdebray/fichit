<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>FichIt - Fiches de révision intelligentes</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="fiches de révision, PDF en fiches, apprentissage visuel, résumés automatiques" name="description" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;600;700&family=Rubik:wght@400;500&display=swap" rel="stylesheet" />

    <!-- Icons -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries -->
    <link href="lib/animate/animate.min.css" rel="stylesheet">
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="lib/lightbox/css/lightbox.min.css" rel="stylesheet">

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Template -->
    <link href="css/style.css" rel="stylesheet">

    <style>
      :root { --accent:#ff385c; --accent-hover:#e33251; }

      html { scroll-behavior: smooth; }
      [id] { scroll-margin-top: 100px; }

      .text-primary { color: var(--accent) !important; }
      .bg-primary { background-color: var(--accent) !important; }
      .border-primary { border-color: var(--accent) !important; }

      .btn-primary { background-color: var(--accent) !important; border-color: var(--accent) !important; color:#fff !important; }
      .btn-primary:hover { background-color: var(--accent-hover) !important; border-color: var(--accent-hover) !important; }

      /* Navbar */
      .navbar { background:#fff; border:none; transition: border-color .2s ease; }
      .avatar { width:34px; height:34px; border-radius:50%; background:#ffe3ea; color:#a41230; font-weight:700; display:flex; align-items:center; justify-content:center; }
      .auth-name { max-width:180px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      /* Same width for auth buttons */
      .auth-btn { min-width:150px; }

      /* Plan badge */
      .plan-badge{
        display:inline-flex; align-items:center; gap:6px;
        border:1px solid var(--accent); color:var(--accent); background:#fff;
        padding:4px 10px; border-radius:999px; font-size:.85rem; font-weight:700;
        line-height:1;
      }
      .plan-badge.premium{ background:var(--accent); color:#fff; border-color:var(--accent); }
      .plan-dot{ width:8px; height:8px; border-radius:50%; background:var(--accent); display:inline-block; }
      .plan-badge.premium .plan-dot{ background:#fff; }

      /* Drawer small badge */
      .drawer-plan{ font-size:.8rem; font-weight:700; }

      /* Hero — larger & bolder */
      .hero-header { padding-top:148px; padding-bottom:96px; position:relative; }
      .hero-header .display-4 { font-weight:800; }
      @media (min-width:992px){
        .hero-header .display-4{ font-size:3rem; }
        .hero-header p.fs-4{ font-size:1.35rem !important; }
      }
      @media (min-width:1200px){
        .hero-header{ padding-top:168px; padding-bottom:120px; }
        .hero-header .display-4{ font-size:3.25rem; }
      }
      .rotate-img img { opacity:.08; }

      /* Sections */
      .section-spacing { padding-top:6rem; padding-bottom:3rem; }

      /* Service equal heights */
      .service .col-md-6, .service .col-lg-4, .service .col-xl-3 { display:flex; }
      .service-item { height:100%; display:flex; flex-direction:column; }
      .service-item .service-icon { min-height:120px; display:flex; align-items:center; justify-content:center; margin-bottom:1.5rem !important; width:100%; }
      .service-item .service-content { flex:1 1 auto; display:flex; flex-direction:column; align-items:center; text-align:center; }
      .service-item .service-content a.btn { margin-top:auto; }

      /* Pricing — improved card visuals */
      .price .btn { background-color:var(--accent) !important; border-color:var(--accent) !important; color:#fff !important; }
      .price .btn:hover { background-color:var(--accent-hover) !important; border-color:var(--accent-hover) !important; }
      .price-item {
        position:relative;
        overflow:hidden;
        border-radius:16px;
        background: #f9fafb;
        box-shadow:0 8px 30px rgba(0,0,0,.06);
        transition:transform .15s ease, box-shadow .15s ease;
      }
      .price-item:hover{
        transform: translateY(-4px);
        box-shadow:0 14px 40px rgba(0,0,0,.10);
      }
      .price-header {
        background: linear-gradient(180deg,#ffffff 0%, #fff3f6 100%);
        border-top-left-radius:16px; border-top-right-radius:16px;
      }
      .features p{ margin-bottom:.6rem; }

      /* Corner badge */
      .price-item-badge{
        position:absolute; top:0; right:0; background:var(--accent); color:#fff;
        font-weight:800; text-transform:uppercase; letter-spacing:.5px;
        padding:8px 14px 10px 16px; line-height:1.1; border-top-right-radius:16px;
        clip-path: polygon(0 0, 100% 0, 100% 100%, 14px 100%, 0 calc(100% - 14px));
        box-shadow:0 8px 20px rgba(255,56,92,.35); z-index:5; pointer-events:none;
      }

      /* FAQ */
      .accordion-button:focus { box-shadow:none; }
      .accordion-button:not(.collapsed) { background:#fff1f4; color:#000; }

      /* FAB (+) */
      .fab { position:fixed; right:18px; bottom:18px; z-index:1050; width:56px; height:56px; border-radius:50%; display:none; align-items:center; justify-content:center; box-shadow:0 10px 25px rgba(255,56,92,.35); }
      @media (max-width:575.98px){ .fab{display:flex;} .hero-cta{display:none !important;} .service-item .service-icon{min-height:100px;} }

      /* Drawer */
      .mobile-drawer-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; z-index:1051; }
      .mobile-drawer { position:fixed; top:0; right:-320px; width:280px; height:100vh; background:#fff; box-shadow:-10px 0 30px rgba(0,0,0,.12); z-index:1052; padding:18px; transition:right .2s ease; display:flex; flex-direction:column; gap:12px; }
      .mobile-drawer.open { right:0; }
      .mobile-drawer-backdrop.show { display:block; }

      /* Spinner */
      #spinner { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#fff; opacity:0; visibility:hidden; transition:opacity .3s ease; z-index:9999; }
      #spinner.show { opacity:1; visibility:visible; }

      /* --- Fix "Comment ça marche" --- */
/* Neutralise d'éventuels styles globaux .feature/.col qui cassent la grille */
#how-it-works .row { margin-left: 0; margin-right: 0; }
#how-it-works .col { display: block; }

/* Assure la même hauteur des cartes via d-flex sur .col et flex-fill sur .how-card */
#how-it-works .how-card{
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.06);
  padding:24px;
  text-align:center;
  display:flex;
  flex-direction:column;
  gap:10px;
}

#how-it-works .how-icon{
  width:90px; height:90px;
  border-radius:50%;
  background:#fff1f4;
  display:flex;
  align-items:center;
  justify-content:center;
  margin:0 auto 6px;
}

#how-it-works .how-step{ font-weight:700; margin-bottom:4px; }
#how-it-works .how-desc{ margin:0; color:#333; }

/* Empêche tout style externe sur .feature d'interférer */
#how-it-works * { box-sizing: border-box; }

    </style>
  </head>

  <body id="top">
    <!-- Spinner -->
    <div id="spinner">
      <div class="spinner-border text-primary" style="width:3rem;height:3rem" role="status" aria-label="Chargement"></div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top navbar-light px-4 px-lg-5 py-3 py-lg-0">
      <a href="#top" class="navbar-brand p-0">
        <img src="img/logo.png" alt="FichIt Logo" style="height: 40px;">
      </a>
      <button class="navbar-toggler" type="button" id="mobileMenuBtn" aria-label="Menu">
        <span class="fa fa-bars"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarCollapse">
        <div class="navbar-nav ms-auto py-0">
          <a href="#top" class="nav-item nav-link active">Accueil</a>
          <a href="#features" class="nav-item nav-link">Fonctionnalités</a>
          <a href="#pricing" class="nav-item nav-link">Tarifs</a>
        </div>
        <div id="authArea" class="d-none d-lg-flex align-items-center ms-3 gap-2"></div>
      </div>
    </nav>

    <!-- Drawer mobile -->
    <div class="mobile-drawer-backdrop" id="drawerBackdrop"></div>
    <div class="mobile-drawer" id="drawer">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="d-flex align-items-center gap-2">
          <div id="drawerAvatar" class="avatar">U</div>
          <div class="d-flex flex-column">
            <div id="drawerName" class="fw-semibold">Utilisateur</div>
            <div id="drawerPlan" class="drawer-plan text-muted">Gratuit</div>
          </div>
        </div>
        <button class="btn btn-sm btn-light" id="closeDrawer" aria-label="Fermer"><i class="fas fa-times"></i></button>
      </div>
      <hr class="mt-0">
      <div id="drawerActions" class="d-grid gap-2"></div>
    </div>

    <!-- Hero -->
    <div class="container-fluid header position-relative overflow-hidden p-0">
      <div class="hero-header overflow-hidden px-5">
        <div class="rotate-img">
          <img src="img/sty-1.png" class="img-fluid w-100" alt="">
        </div>
        <div class="row gy-5 align-items-center">
          <div class="col-lg-12 text-center">
            <h1 class="display-4 text-dark mb-4">Transformez vos PDF en fiches de révision visuelles</h1>
            <p class="fs-4 mb-4">Déposez vos cours, obtenez des fiches claires et optimisées pour apprendre plus vite.</p>
            <a href="login.html?tab=register" id="uploadCta" class="btn btn-primary rounded-pill py-3 px-5 hero-cta">Déposez votre PDF</a>
          </div>
        </div>
      </div>
    </div>

    <!-- About -->
    <div class="container-fluid overflow-hidden py-5 section-spacing">
      <div class="container py-5">
        <div class="row g-5">
          <div class="col-lg-6">
            <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
              <i class="fas fa-mouse-pointer fa-10x text-primary"></i>
            </div>
          </div>
          <div class="col-lg-6">
            <h4 class="mb-1 text-primary">Pourquoi FichIt ?</h4>
            <h1 class="display-5 mb-4">Des fiches de révision parfaites en un clic</h1>
            <p class="mb-4">Notre IA analyse vos PDF et génère des fiches structurées, avec tableaux et mots-clés, pour maximiser votre efficacité d’apprentissage.</p>
            <a href="#features" class="btn btn-primary rounded-pill py-3 px-5">Découvrir comment ça marche</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Fonctionnalités -->
    <div id="features" class="container-fluid service py-5 section-spacing">
      <div class="container py-5">
        <div class="text-center mx-auto mb-5" style="max-width: 900px;">
          <h4 class="mb-1 text-primary">Nos Fonctionnalités</h4>
          <h1 class="display-5 mb-4">Tout ce dont vous avez besoin pour réussir</h1>
          <p class="mb-0">Génération automatique et export : FichIt s’adapte à vos besoins.</p>
        </div>
        <div class="row g-4 justify-content-center">
          <div class="col-md-6 col-lg-4 col-xl-3">
            <div class="service-item text-center rounded p-4 h-100">
              <div class="service-icon d-inline-block bg-light rounded p-4 mb-4">
                <i class="fas fa-file-pdf fa-5x text-primary"></i>
              </div>
              <div class="service-content">
                <h4 class="mb-3">Import de PDF</h4>
                <p class="mb-4">Déposez vos cours au format PDF, notre IA extrait le contenu essentiel.</p>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-4 col-xl-3">
            <div class="service-item text-center rounded p-4 h-100">
              <div class="service-icon d-inline-block bg-light rounded p-4 mb-4">
                <i class="fas fa-robot fa-5x text-primary"></i>
              </div>
              <div class="service-content">
                <h4 class="mb-3">Génération IA</h4>
                <p class="mb-4">L’IA crée des fiches claires, avec tableaux et résumés pertinents.</p>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-4 col-xl-3">
            <div class="service-item text-center rounded p-4 h-100">
              <div class="service-icon d-inline-block bg-light rounded p-4 mb-4">
                <i class="fas fa-share-alt fa-5x text-primary"></i>
              </div>
              <div class="service-content">
                <h4 class="mb-3">Export</h4>
                <p class="mb-4">Exportez en PDF prêt à l'emploi.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Comment ça marche -->
  <!-- Comment ça marche (robuste) -->
<section class="container-fluid overflow-hidden py-5 section-spacing" id="how-it-works">
  <div class="container py-5">
    <div class="text-center mx-auto mb-5" style="max-width: 900px;">
      <h4 class="text-primary">Comment ça marche ?</h4>
      <h1 class="display-5 mb-4">En 3 étapes simples</h1>
      <p class="mb-0">Pas besoin d’être un expert : FichIt fait tout le travail pour vous.</p>
    </div>

    <div class="row row-cols-1 row-cols-md-3 g-4 how-grid">
      <div class="col d-flex">
        <div class="how-card flex-fill h-100">
          <div class="how-icon"><i class="fas fa-upload fa-2x text-primary" aria-hidden="true"></i></div>
          <div class="how-step h5 mb-0">1. Déposez votre PDF</div>
          <p class="how-desc">Glissez-déposez votre fichier ou sélectionnez-le depuis votre appareil.</p>
        </div>
      </div>
      <div class="col d-flex">
        <div class="how-card flex-fill h-100">
          <div class="how-icon"><i class="fas fa-cog fa-2x text-primary" aria-hidden="true"></i></div>
          <div class="how-step h5 mb-0">2. Laissez l’IA travailler</div>
          <p class="how-desc">Notre algorithme analyse et génère votre fiche en quelques secondes.</p>
        </div>
      </div>
      <div class="col d-flex">
        <div class="how-card flex-fill h-100">
          <div class="how-icon"><i class="fas fa-file-download fa-2x text-primary" aria-hidden="true"></i></div>
          <div class="how-step h5 mb-0">3. Téléchargez votre fiche</div>
          <p class="how-desc">Récupérez votre fiche prête à l’emploi.</p>
        </div>
      </div>
    </div>
  </div>
</section>

    <!-- FAQ -->
    <div class="container-fluid FAQ bg-light overflow-hidden py-5 section-spacing">
      <div class="container py-5">
        <div class="row g-5 align-items-center">
          <div class="col-lg-6">
            <div class="accordion" id="accordionExample">
              <div class="accordion-item border-0 mb-4">
                <h2 class="accordion-header" id="headingOne">
                  <button class="accordion-button rounded-top" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true">
                    Comment ça marche ?
                  </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">
                  <div class="accordion-body my-2">
                    Déposez votre PDF, notre IA extrait le contenu et génère une fiche structurée. Vous pouvez ensuite la télécharger directement.
                  </div>
                </div>
              </div>
              <div class="accordion-item border-0 mb-4">
                <h2 class="accordion-header" id="headingTwo">
                  <button class="accordion-button collapsed rounded-top" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                    Est-ce que mes données sont sécurisées ?
                  </button>
                </h2>
                <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                  <div class="accordion-body my-2">
                    Oui, absolument. Nous ne stockons pas vos PDF après traitement et vos fiches sont privées.
                  </div>
                </div>
              </div>
              <div class="accordion-item border-0 mb-4">
                <h2 class="accordion-header" id="headingThree">
                  <button class="accordion-button collapsed rounded-top" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                    Quels formats sont acceptés ?
                  </button>
                </h2>
                <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                  <div class="accordion-body my-2">
                    Actuellement, nous acceptons uniquement les fichiers PDF. Les autres formats arrivent très bientôt.
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6 text-center">
            <i class="fas fa-question-circle fa-10x text-primary"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Pricing -->
    <div id="pricing" class="container-fluid price py-5 section-spacing">
      <div class="container py-5">
        <div class="text-center mx-auto mb-5" style="max-width: 900px;">
          <h4 class="text-primary">Nos Tarifs</h4>
          <h1 class="display-5 mb-4">Des offres adaptées à tous</h1>
        </div>
        <div class="row g-5 justify-content-center">
          <div class="col-md-6 col-lg-6 col-xl-4">
            <div class="price-item text-center">
              <div class="price-header text-dark border-bottom d-flex flex-column justify-content-center p-4" style="width:100%;height:160px;">
                <p class="fs-2 fw-bold text-uppercase mb-0">GRATUIT</p>
                <div class="d-flex justify-content-center">
                  <strong class="align-self-start">€</strong>
                  <p class="mb-0"><span class="display-5">0</span>/mois</p>
                </div>
              </div>
              <div class="features p-5">
                <p><i class="fas fa-check text-success me-1"></i> 5 fiches/mois</p>
                <p><i class="fas fa-check text-success me-1"></i> Export en PDF</p>
                <p class="mb-4"><i class="fas fa-times text-danger me-1"></i> Accès prioritaire</p>
                <a class="btn btn-primary rounded-pill py-2 px-5" href="login.html?plan=free">Commencer</a>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-6 col-xl-4">
            <div class="price-item text-center position-relative">
              <div class="price-item-badge">Populaire</div>
              <div class="price-header text-primary border-bottom d-flex flex-column justify-content-center p-4" style="width:100%;height:160px;">
                <p class="fs-2 fw-bold text-uppercase mb-0">PREMIUM</p>
                <div class="d-flex justify-content-center">
                  <strong class="align-self-start">€</strong>
                  <p class="mb-0"><span class="display-5">5</span>/mois</p>
                </div>
              </div>
              <div class="features p-5">
                <p><i class="fas fa-check text-success me-1"></i> Fiches illimitées</p>
                <p><i class="fas fa-check text-success me-1"></i> Export en PDF</p>
                <p class="mb-4"><i class="fas fa-check text-success me-1"></i> Accès prioritaire</p>
                <a class="btn btn-primary rounded-pill py-2 px-5" href="login.html?plan=premium">Commencer</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer minimal -->
    <div class="text-center">
      <a href="docs/conditions.pdf" target="_blank" rel="noopener" class="me-3" aria-label="Ouvrir les Conditions générales (PDF)">Conditions générales</a>
      <a href="docs/confidentialite.pdf" target="_blank" rel="noopener" aria-label="Ouvrir la Politique de confidentialité (PDF)">Politique de confidentialité</a>
      <div class="mt-2">
        <small class="text-muted">© 2025 FichIt – Tous droits réservés.</small>
      </div>
    </div>

    <!-- FAB mobile -->
    <a href="login.html?tab=register" id="fab" class="btn btn-primary fab" aria-label="Déposer un PDF"><i class="fas fa-plus"></i></a>

    <!-- JS libs -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/wow/wow.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/counterup/counterup.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="lib/lightbox/js/lightbox.min.js"></script>
    <script src="js/main.js"></script>

    <!-- Bordure au scroll -->
    <script>
      window.addEventListener('scroll', () => {
        const navbar = document.querySelector('.navbar');
        navbar.style.borderBottom = window.scrollY > 10 ? '1px solid #eee' : 'none';
      });
    </script>

    <!-- Firebase + spinner fix + auth UI (+ badge plan) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
      import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

      const firebaseConfig = { apiKey:"AIzaSyCUYgbDvFb4FjaMrsL-2-wVjlME5iODVOs", authDomain:"fichit-64628.firebaseapp.com", projectId:"fichit-64628" };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      setPersistence(auth, browserLocalPersistence).catch(()=>{});

      const spinner = document.getElementById('spinner');
      const hideSpinner = () => { spinner.classList.remove('show'); spinner.style.display = "none"; };
      setTimeout(hideSpinner, 1000);
      spinner.classList.add('show');

      // Drawer
      const drawer = document.getElementById('drawer');
      const drawerBackdrop = document.getElementById('drawerBackdrop');
      const drawerActions = document.getElementById('drawerActions');
      const drawerAvatar = document.getElementById('drawerAvatar');
      const drawerName = document.getElementById('drawerName');
      const drawerPlan = document.getElementById('drawerPlan');
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const closeDrawer = document.getElementById('closeDrawer');
      const openDrawer = ()=>{drawer.classList.add('open');drawerBackdrop.classList.add('show');};
      const closeDrawerFn = ()=>{drawer.classList.remove('open');drawerBackdrop.classList.remove('show');};
      mobileMenuBtn?.addEventListener('click', openDrawer);
      closeDrawer?.addEventListener('click', closeDrawerFn);
      drawerBackdrop?.addEventListener('click', closeDrawerFn);

      // UI
      const authArea = document.getElementById('authArea');
      const uploadCta = document.getElementById('uploadCta');
      const fab = document.getElementById('fab');

      function fastLogout({ btn } = {}) {
        if (btn) { btn.disabled = true; btn.textContent = 'Déconnexion…'; }
        signOut(auth).finally(()=>location.href='index.html');
      }

      function setPlanBadgeUI({ isPremium }) {
        const planBadge = document.getElementById('planBadge');
        const planBadgeText = document.getElementById('planBadgeText');

        if (!planBadge || !planBadgeText) return;

        if (isPremium) {
          planBadge.classList.add('premium');
          planBadgeText.textContent = 'Premium';
        } else {
          planBadge.classList.remove('premium');
          planBadgeText.textContent = 'Gratuit';
        }

        // Drawer small text
        if (drawerPlan) drawerPlan.textContent = isPremium ? 'Premium' : 'Gratuit';
      }

      async function updateBadgeFromClaims(user, force=false){
        const tokenResult = await user.getIdTokenResult(force).catch(()=>null);
        const isPremium = !!(tokenResult && tokenResult.claims && tokenResult.claims.premium);
        setPlanBadgeUI({ isPremium });
        return isPremium;
      }

      async function fallbackFromFirestore(uid){
        try{
          const snap = await getDoc(doc(db, "users", uid));
          const plan = (snap.exists() && snap.data().plan) || 'free';
          setPlanBadgeUI({ isPremium: plan === 'premium' });
        }catch{}
      }

      function renderLoggedOut() {
        authArea.innerHTML = `
          <a href="login.html?tab=login" class="btn btn-light rounded-pill text-white py-2 px-4 me-2 auth-btn">Connexion</a>
          <a href="login.html?tab=register" class="btn btn-primary rounded-pill text-white py-2 px-4 auth-btn">Inscription</a>
        `;
        drawerAvatar.textContent = 'U';
        drawerName.textContent = 'Invité';
        drawerPlan.textContent = 'Gratuit';
        drawerActions.innerHTML = `
          <a class="btn btn-primary w-100" href="login.html?tab=register"><i class="fas fa-user-plus me-1"></i> Créer un compte</a>
          <a class="btn btn-light w-100" href="login.html?tab=login"><i class="fas fa-sign-in-alt me-1"></i> Se connecter</a>
        `;
        uploadCta.setAttribute('href','login.html?tab=register');
        fab.setAttribute('href','login.html?tab=register');
      }

      function renderLoggedIn(user) {
        const name = user.displayName || user.email || 'Utilisateur';
        const initial = (name.trim()[0]||'U').toUpperCase();
        authArea.innerHTML = `
          <div class="d-none d-xl-flex align-items-center me-2">
            <div class="avatar me-2">${initial}</div>
            <div class="d-flex flex-column">
              <span class="auth-name">${name}</span>
              <span class="plan-badge mt-1" id="planBadge"><span class="plan-dot"></span><span id="planBadgeText">Gratuit</span></span>
            </div>
          </div>
          <a href="dashboard.html" class="btn btn-primary rounded-pill text-white py-2 px-3">Mon tableau de bord</a>
          <button id="logoutBtn" class="btn btn-outline-danger rounded-pill py-2 px-3 ms-1">Se déconnecter</button>
        `;

        drawerAvatar.textContent = initial;
        drawerName.textContent = name;
        // drawerPlan est mis à jour par setPlanBadgeUI
        drawerActions.innerHTML = `
          <a class="btn btn-primary w-100" href="dashboard.html"><i class="fas fa-chart-line me-1"></i> Mon tableau de bord</a>
          <a class="btn btn-light w-100" href="upload.html"><i class="fas fa-file-upload me-1"></i> Déposer un PDF</a>
          <button id="drawerLogout" class="btn btn-outline-danger w-100"><i class="fas fa-sign-out-alt me-1"></i> Se déconnecter</button>
        `;
        const logoutBtn = document.getElementById('logoutBtn');
        logoutBtn?.addEventListener('click', ()=>fastLogout({ btn: logoutBtn }));
        const drawerLogout = document.getElementById('drawerLogout');
        drawerLogout?.addEventListener('click', ()=>fastLogout({ btn: drawerLogout }));

        uploadCta.setAttribute('href','upload.html');
        fab.setAttribute('href','upload.html');
      }

      onAuthStateChanged(auth, async (user) => {
        hideSpinner();
        if (!user) { renderLoggedOut(); return; }

        renderLoggedIn(user);

        // 1) Affichage immédiat (token courant)
        let hasPremium = await updateBadgeFromClaims(user, false);

        // 2) Force refresh (utile au retour Stripe)
        if (!hasPremium) hasPremium = await updateBadgeFromClaims(user, true);

        // 3) Fallback Firestore
        if (!hasPremium) fallbackFromFirestore(user.uid);

        // 4) Retentes pendant 60s (propagation claim)
        let tries = 0;
        const iv = setInterval(async ()=>{
          tries++;
          const ok = await updateBadgeFromClaims(user, true);
          if (ok || tries >= 20) clearInterval(iv); // 20 * 3s = 60s
        }, 3000);
      }, () => { hideSpinner(); renderLoggedOut(); });

      // Refresh quand l’onglet redevient visible (retour de Stripe par ex.)
      document.addEventListener('visibilitychange', async ()=>{
        if (document.visibilityState === 'visible' && auth.currentUser){
          await updateBadgeFromClaims(auth.currentUser, true);
        }
      });
    </script>
  </body>
</html>
